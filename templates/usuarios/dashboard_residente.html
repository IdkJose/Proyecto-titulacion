<!DOCTYPE html>
<html lang="es">
{% load custom_tags %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Conjunto Selva Alegre</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
</head>

<body>
    <header>
        <div class="header-content">
            <h1>üèòÔ∏è Conjunto Selva Alegre</h1>
            <div class="user-info">
                <span><strong>{{ usuario.username }}</strong></span>
                <link rel="stylesheet"
                    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=home" />
                <a href="{% url 'usuarios:home' %}" class="btn-home">
                    <span class="material-symbols-outlined">home</span>
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-success">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="dashboard-grid">
            <!-- COLUMNA 1: Informaci√≥n del usuario -->
            <div class="dashboard-content">
                <div class="welcome-section">
                    <h2>Bienvenido {{ usuario.get_full_name|default:usuario.username }}</h2>
                    <p>Aqu√≠ puedes ver tu informaci√≥n y acceder a los servicios del conjunto üòä</p>

                    <div class="user-card">
                        <div class="user-card-header">üìã Informaci√≥n del Usuario</div>
                        <div class="user-card-body">
                            <div class="user-info-row">
                                <div class="user-info-label"><i class="material-icons">person</i> Usuario</div>
                                <div class="user-info-value">{{ usuario.username }}</div>
                            </div>
                            <div class="user-info-row">
                                <div class="user-info-label"><i class="material-icons">mail</i> Email</div>
                                <div class="user-info-value">{{ usuario.email }}</div>
                            </div>
                            <div class="user-info-row">
                                <div class="user-info-label"><i class="material-icons">home</i> Casa</div>
                                <div class="user-info-value">{{ usuario.casa_departamento|default:"No registrado" }}
                                </div>
                            </div>
                            <div class="user-info-row">
                                <div class="user-info-label"><i class="material-icons">phone</i> Tel√©fono</div>
                                <div class="user-info-value">{{ usuario.telefono|default:"No registrado" }}</div>
                            </div>
                            <div class="user-info-row">
                                <div class="user-info-label"><i class="material-icons">badge</i> Rol</div>
                                <div class="user-info-value">{{ usuario.get_rol_display }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card" onclick="expandCard(event, 'perfil')">
                        <h3>üìã Mi Perfil</h3>
                        <p>Visualiza y edita tu informaci√≥n personal.</p>
                        <div class="card-content" id="perfil-content" style="display: none;">
                            <h2>Mi Informaci√≥n Personal</h2>
                            <div class="perfil-info">
                                <p><strong>Usuario:</strong> {{ usuario.username }}</p>
                                <p><strong>Nombre:</strong> {{ usuario.get_full_name }}</p>
                                <p><strong>Email:</strong> {{ usuario.email }}</p>
                                <p><strong>Casa/Depto:</strong> {{ usuario.casa_departamento }}</p>
                                <p><strong>Tel√©fono:</strong> {{ usuario.telefono|default:"No registrado" }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card" onclick="expandCard(event, 'solicitudes')">
                        <h3>üìå Solicitudes</h3>
                        <p>Gestiona tus solicitudes y tr√°mites.</p>
                        {% if solicitudes.count > 0 %}
                        <div class="badge">{{ solicitudes.count }}</div>
                        {% endif %}

                        <div class="card-content" id="solicitudes-content" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                <button class="btn-opcion" onclick="abrirModalVerSolicitudes(event)">
                                    üìã Ver Solicitudes
                                </button>
                                <button class="btn-opcion" onclick="abrirModalNuevaSolicitud(event)">
                                    ‚ûï Crear Nueva Solicitud
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card" onclick="expandCard(event, 'mensajes')">
                        <h3>üí¨ Mensajes</h3>
                        <p>Comunicaci√≥n con la administraci√≥n.</p>
                        <div class="card-content" id="mensajes-content" style="display: none;">
                            <h2>Mensajes</h2>
                            <p>Pr√≥ximamente...</p>
                        </div>
                    </div>

                    <div class="card" onclick="expandCard(event, 'reportes')">
                        <h3>üìä Reportes</h3>
                        <p>Consulta reportes y documentos.</p>
                        <div class="card-content" id="reportes-content" style="display: none;">
                            <h2>Reportes</h2>
                            <p>Pr√≥ximamente...</p>
                        </div>
                    </div>

                    <div class="card" onclick="expandCard(event, 'mascotas')">
                        <h3>üê∂ Mascotas</h3>
                        <p>Consulta las mascotas que se encuentran dentro del conjunto</p>
                        {% if mascotas.count > 0%}
                        <div class="badge">{{ mascotas.count }}</div>
                        {% endif %}
                        <div class="card-content" id="mascotas-content" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                <button class="btn-opcion" onclick="abrirModalVerMascotas(event)">
                                    üìã Ver Mascotas
                                </button>
                                <button class="btn-opcion" onclick="abrirModalNuevaMascota(event)">
                                    ‚ûï Crear Nueva Mascota
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card" onclick="expandCard(event, 'vehiculos')">
                        <h3>üöó Veh√≠culos</h3>
                        <p>Consulta los veh√≠culos registrados dentro del conjunto</p>
                        {% if vehiculos.count > 0%}
                        <div class="badge">{{ vehiculos.count }}</div>
                        {% endif %}
                        <div class="card-content" id="vehiculos-content" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                                <button class="btn-opcion" onclick="abrirModalVerVehiculos(event)">
                                    üìã Ver Veh√≠culos
                                </button>
                                <button class="btn-opcion" onclick="abrirModalNuevaVehiculo(event)">
                                    ‚ûï Registrar Nuevo Veh√≠culo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA 2: Calendario -->
            <div class="dashboard-content">
                <div class="calendario-header">
                    <div class="calendario-header-left">
                        <a href="?mes={{ mes_anterior }}&ano={{ ano_anterior }}">‚Üê Anterior</a>
                    </div>
                    <div class="calendario-header-right">
                        <a href="?mes={{ mes_siguiente }}&ano={{ ano_siguiente }}">Siguiente ‚Üí</a>
                    </div>
                </div>

                <h3 style="text-align: center; color: #667eea; margin-bottom: 15px;">
                    üìÖ {{ mes_nombre }} {{ ano }}
                </h3>

                <table class="tabla-calendario">
                    <thead>
                        <tr>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Mi√©rcoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                            <th>S√°bado</th>
                            <th>Domingo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for semana in calendario %}
                        <tr>
                            {% for dia in semana %}
                            <td class="{% if dia == 0 %}vacio{% endif %}">
                                {% if dia != 0 %}
                                <div class="numero-dia">{{ dia }}</div>
                                {% if eventos_por_dia|get_dict:dia %}
                                <div class="eventos">
                                    {% for evento in eventos_por_dia|get_dict:dia %}
                                    <span class="evento" style="background-color: {{ evento.color }}" onclick="openEventModal({
                                            titulo: '{{ evento.titulo|escapejs }}',
                                            fecha: '{{ evento.fecha_inicio|date:'d/m/Y' }}',
                                            hora: '{{ evento.fecha_inicio|date:'H:i' }}',
                                            descripcion: '{{ evento.descripcion|escapejs }}',
                                            categoria: '{{ evento.get_categoria_display }}',
                                            color: '{{ evento.color }}'
                                        })">>
                                        {{ evento.titulo }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="contador-eventos">
                    üìç Total de eventos este mes: <strong>{{ eventos_por_dia|length }}</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar detalles del evento -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">
                    <i class="material-icons" style="color: white;">event</i>
                    <span id="modalEventTitle"></span>
                </h3>
                <button class="close-modal" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="event-detail-row">
                    <i class="material-icons event-detail-icon">calendar_today</i>
                    <div class="event-detail-content">
                        <div class="event-label">Fecha</div>
                        <div class="event-value" id="modalEventDate"></div>
                    </div>
                </div>
                <div class="event-detail-row">
                    <i class="material-icons event-detail-icon">schedule</i>
                    <div class="event-detail-content">
                        <div class="event-label">Hora</div>
                        <div class="event-value" id="modalEventTime"></div>
                    </div>
                </div>
                <div class="event-detail-row">
                    <i class="material-icons event-detail-icon">description</i>
                    <div class="event-detail-content">
                        <div class="event-label">Descripci√≥n</div>
                        <div class="event-value" id="modalEventDescription"></div>
                    </div>
                </div>
                <div class="event-detail-row">
                    <i class="material-icons event-detail-icon">category</i>
                    <div class="event-detail-content">
                        <div class="event-label">Categor√≠a</div>
                        <div class="event-value" id="modalEventCategory"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de solicitudes -->
    <div id="modal-ver-solicitudes" class="formulario-modal"
        onclick="if(event.target === this) cerrarModalVerSolicitudes();">
        <div class="formulario-contenido" onclick="event.stopPropagation();">
            <span class="cerrar" onclick="cerrarModalVerSolicitudes()">&times;</span>
            <h2>üìã Mis Solicitudes</h2>
            {% if solicitudes %}
            <div class="solicitudes-lista">
                {% for solicitud in solicitudes %}
                <div class="solicitud-card" onclick="expandirSolicitud(this)">
                    <div class="solicitud-header">
                        <div class="solicitud-info">
                            <h3>{{ solicitud.titulo }}</h3>
                            <span class="solicitud-tipo">{{ solicitud.get_tipo_display }}</span>
                        </div>
                        <div class="solicitud-estado estado-{{ solicitud.estado }}">
                            {{ solicitud.get_estado_display }}
                        </div>
                    </div>
                    <div class="solicitud-fecha">
                        Creada: {{ solicitud.fecha_creacion|date:"d/m/Y H:i" }}
                    </div>
                    <div class="solicitud-body" style="display: none;">
                        <p><strong>Descripci√≥n:</strong></p>
                        <p>{{ solicitud.descripcion }}</p>
                        {% if solicitud.respuesta_admin %}
                        <p><strong>Respuesta del administrador:</strong></p>
                        <div class="respuesta-admin">
                            {{ solicitud.respuesta_admin }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="sin-solicitudes">
                <p>No tienes solicitudes a√∫n.</p>
            </div>
            {% endif %}

            <div class="form-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-cancelar" onclick="cerrarModalVerSolicitudes()"
                    style="width: 100%;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVA MASCOTA -->
    <div id="modal-nueva-mascota" class="formulario-modal"
        onclick="if(event.target === this) cerrarModalNuevaMascota();">
        <div class="formulario-contenido" onclick="event.stopPropagation();">
            <span class="cerrar" onclick="cerrarModalNuevaMascota()">&times;</span>
            <h2>üê∂ Registrar Nueva Mascota</h2>
            <form method="POST" action="{% url 'usuarios:crear_mascota' %}" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-group">
                    <label for="numero-casa">N√∫mero de Casa:</label>
                    <input type="text" name="numero_casa" id="numero-casa" required>
                </div>

                <div class="form-group">
                    <label for="nombre-mascota">Nombre de la Mascota:</label>
                    <input type="text" name="nombre" id="nombre-mascota" required>
                </div>

                <div class="form-group">
                    <label for="dueno">Due√±o:</label>
                    <input type="text" name="dueno" id="dueno" required>
                </div>

                <div class="form-group">
                    <label for="tipo-mascota">Tipo de Mascota:</label>
                    <select name="tipo" id="tipo-mascota" required>
                        <option value="">-- Selecciona un tipo --</option>
                        <option value="perro">üêï Perro</option>
                        <option value="gato">üê± Gato</option>
                        <option value="pajaro">ü¶ú P√°jaro</option>
                        <option value="conejo">üê∞ Conejo</option>
                        <option value="hamster">üêπ H√°mster</option>
                        <option value="otro">üìù Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="foto-mascota">üì∏ Foto de la Mascota (opcional):</label>
                    <div style="position: relative;">
                        <input type="file" name="foto" id="foto-mascota" accept="image/*"
                            onchange="previewImagenMascota(event)" style="cursor: pointer;">
                    </div>

                    <!-- Preview con cuadr√≠cula ajustable -->
                    <div id="preview-foto-mascota" style="
                        display: none;
                        margin-top: 15px;
                        text-align: center;
                    ">
                        <div id="preview-container" style="
                            position: relative;
                            width: 300px;
                            height: 300px;
                            margin: 0 auto;
                            overflow: hidden;
                            border-radius: 8px;
                            border: 3px solid #667eea;
                            background: #f5f5f5;
                        ">
                            <!-- Imagen fija -->
                            <img id="preview-img-mascota" src="" alt="Preview" style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                user-select: none;
                                pointer-events: none;
                            ">

                            <!-- √Årea de overlay oscuro (fuera de la cuadr√≠cula) -->
                            <div id="overlay-left"
                                style="position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.4); z-index: 5;">
                            </div>
                            <div id="overlay-top"
                                style="position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.4); z-index: 5;">
                            </div>
                            <div id="overlay-right"
                                style="position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.4); z-index: 5;">
                            </div>
                            <div id="overlay-bottom"
                                style="position: absolute; bottom: 0; left: 0; background: rgba(0,0,0,0.4); z-index: 5;">
                            </div>

                            <!-- Cuadr√≠cula 3x3 ajustable -->
                            <div id="crop-frame" style="
                                position: absolute;
                                top: 30px;
                                left: 30px;
                                width: 240px;
                                height: 240px;
                                border: 2px solid rgba(255,255,255,0.8);
                                z-index: 10;
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                grid-template-rows: repeat(3, 1fr);
                                gap: 0;
                                box-shadow: 0 0 0 1px rgba(102, 126, 234, 0.5);
                            ">
                                <div
                                    style="border-right: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.4);">
                                </div>
                                <div
                                    style="border-right: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.4);">
                                </div>
                                <div style="border-bottom: 1px solid rgba(255,255,255,0.4);"></div>

                                <div
                                    style="border-right: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.4);">
                                </div>
                                <div
                                    style="border-right: 1px solid rgba(255,255,255,0.4); border-bottom: 1px solid rgba(255,255,255,0.4);">
                                </div>
                                <div style="border-bottom: 1px solid rgba(255,255,255,0.4);"></div>

                                <div style="border-right: 1px solid rgba(255,255,255,0.4);"></div>
                                <div style="border-right: 1px solid rgba(255,255,255,0.4);"></div>
                                <div></div>
                            </div>

                            <!-- Handles de esquinas -->
                            <div id="handle-tl" class="crop-handle"
                                style="position: absolute; top: 20px; left: 20px; cursor: nwse-resize;"></div>
                            <div id="handle-tr" class="crop-handle"
                                style="position: absolute; top: 20px; right: 20px; cursor: nesw-resize;"></div>
                            <div id="handle-bl" class="crop-handle"
                                style="position: absolute; bottom: 20px; left: 20px; cursor: nesw-resize;"></div>
                            <div id="handle-br" class="crop-handle"
                                style="position: absolute; bottom: 20px; right: 20px; cursor: nwse-resize;"></div>

                            <!-- Indicador -->
                            <div id="drag-hint" style="
                                position: absolute;
                                bottom: 10px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: rgba(102, 126, 234, 0.9);
                                color: white;
                                padding: 5px 10px;
                                border-radius: 4px;
                                font-size: 0.75rem;
                                font-weight: 500;
                                z-index: 20;
                                pointer-events: none;
                            ">
                                Arrastra las esquinas para ajustar
                            </div>
                        </div>
                        <p style="
                            text-align: center;
                            font-size: 0.85rem;
                            color: #667eea;
                            margin-top: 10px;
                            font-weight: 500;
                        ">‚úì Imagen cargada - Ajusta las esquinas</p>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn-enviar">Registrar Mascota</button>
                    <button type="button" class="btn-cancelar" onclick="cerrarModalNuevaMascota()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL VER MASCOTAS -->
    <div id="modal-ver-mascotas" class="formulario-modal" onclick="if(event.target === this) cerrarModalVerMascotas();">
        <div class="formulario-contenido" style="max-width: 900px; max-height: 90vh;"
            onclick="event.stopPropagation();">
            <span class="cerrar" onclick="cerrarModalVerMascotas()">&times;</span>
            <h2>üêæ Mascotas Registradas</h2>

            {% if mascotas %}
            <div
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; max-height: 600px; overflow-y: auto; padding-right: 10px;">
                {% for mascota in mascotas %}
                <div class="mascota-card" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border-radius: 15px;
                            overflow: hidden;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
                            transition: all 0.3s ease;
                            cursor: pointer;
                            color: white;
                        "
                    onmouseover="this.style.transform='translateY(-8px)'; this.style.boxShadow='0 12px 24px rgba(0,0,0,0.2)';"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)';">

                    <!-- Foto o Emoji -->
                    <div style="
                                width: 100%;
                                height: 160px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                position: relative;
                                overflow: hidden;
                            ">
                        {% if mascota.foto %}
                        <img src="{{ mascota.foto.url }}" alt="{{ mascota.nombre }}" style="
                                        width: 100%;
                                        height: 100%;
                                        object-fit: cover;
                                    ">
                        {% else %}
                        <div style="font-size: 4rem;">
                            {% if mascota.tipo == 'perro' %}üêï{% elif mascota.tipo == 'gato' %}üê±{% elif mascota.tipo ==
                            'pajaro' %}ü¶ú{% elif mascota.tipo == 'conejo' %}üê∞{% elif mascota.tipo == 'hamster' %}üêπ{%
                            else %}üêæ{% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Informaci√≥n -->
                    <div style="padding: 15px; background: rgba(255,255,255,0.95); color: #333;">
                        <p style="
                                    margin: 0 0 8px 0;
                                    font-weight: bold;
                                    font-size: 1.2rem;
                                    color: #667eea;
                                    text-align: center;
                                ">{{ mascota.nombre }}</p>

                        <div style="font-size: 0.85rem; line-height: 1.6;">
                            <p style="margin: 4px 0;"><strong>Tipo:</strong> {{ mascota.get_tipo_display }}</p>
                            <p style="margin: 4px 0;"><strong>Casa:</strong> {{ mascota.numero_casa }}</p>
                            <p style="margin: 4px 0;"><strong>Due√±o:</strong> {{ mascota.dueno }}</p>
                        </div>

                        {% if mascota.descripcion %}
                        <p style="
                                        margin: 8px 0 0 0;
                                        padding-top: 8px;
                                        border-top: 1px solid #e0e0e0;
                                        font-size: 0.8rem;
                                        color: #666;
                                        font-style: italic;
                                    ">{{ mascota.descripcion }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="
                    text-align: center;
                    padding: 60px 20px;
                    color: #999;
                ">
                <p style="font-size: 3rem; margin-bottom: 15px;">üêæ</p>
                <p style="font-size: 1.1rem;">No hay mascotas registradas a√∫n.</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">¬°S√© el primero en registrar una mascota!</p>
            </div>
            {% endif %}

            <div class="form-buttons" style="margin-top: 20px;">
                <button type="button" class="btn-cancelar" onclick="cerrarModalVerMascotas()">Cerrar</button>
            </div>
        </div>
    </div>
    </div>
    </div>

    <!-- MODAL NUEVA SOLICITUD -->
    <div id="modal-nueva-solicitud" class="formulario-modal"
        onclick="if(event.target === this) cerrarModalNuevaSolicitud();">
        <div class="formulario-contenido" onclick="event.stopPropagation();">
            <span class="cerrar" onclick="cerrarModalNuevaSolicitud()">&times;</span>
            <h2>‚ûï Nueva Solicitud</h2>
            <form method="POST" action="{% url 'usuarios:crear_solicitud' %}">
                {% csrf_token %}

                <div class="form-group">
                    <label for="tipo-modal">Tipo de Solicitud:</label>
                    <select name="tipo" id="tipo-modal" required>
                        <option value="">-- Selecciona un tipo --</option>
                        <option value="mantenimiento">üîß Mantenimiento</option>
                        <option value="permiso">‚úÖ Permiso</option>
                        <option value="queja">‚ö†Ô∏è Queja</option>
                        <option value="sugerencia">üí° Sugerencia</option>
                        <option value="otro">üìù Otro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="titulo-modal">Asunto:</label>
                    <input type="text" name="titulo" id="titulo-modal" placeholder="¬øcu√°l es tu solicitud?" required>
                </div>

                <div class="form-group">
                    <label for="descripcion-modal">Descripci√≥n:</label>
                    <textarea name="descripcion" id="descripcion-modal" rows="3"
                        placeholder="Cu√©ntanos m√°s detalles sobre tu solicitud..." required></textarea>
                </div>

                <div class="form-buttons">
                    <button type="submit" class="btn-enviar">Enviar Solicitud</button>
                    <button type="button" class="btn-cancelar" onclick="cerrarModalNuevaSolicitud()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="footer">
        <p>&copy; 2025 Conjunto Residencial Selva Alegre. Todos los derechos reservados.</p>

        <script>
            // Funci√≥n para abrir el modal con los detalles del evento
            function openEventModal(eventData) {
                document.getElementById('modalEventTitle').textContent = eventData.titulo;
                document.getElementById('modalEventDate').textContent = eventData.fecha;
                document.getElementById('modalEventTime').textContent = eventData.hora || 'No especificada';
                document.getElementById('modalEventDescription').textContent = eventData.descripcion || 'Sin descripci√≥n';
                document.getElementById('modalEventCategory').textContent = eventData.categoria || 'Sin categor√≠a';

                const modal = document.getElementById('eventModal');
                modal.style.display = 'flex';
            }

            // Funci√≥n para cerrar el modal
            function closeEventModal() {
                const modal = document.getElementById('eventModal');
                modal.style.display = 'none';
            }

            // Cerrar modal al hacer click fuera de √©l
            document.addEventListener('click', function (event) {
                const modal = document.getElementById('eventModal');
                if (event.target === modal) {
                    closeEventModal();
                }
            });

            // Cerrar modal con la tecla Escape
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeEventModal();
                }
            });

            // Funci√≥n para cambiar entre tabs
            function cambiarTab(event, tabId) {
                event.preventDefault();
                event.stopPropagation();

                // Ocultar todos los tabs
                const allTabs = document.querySelectorAll('.tab-content');
                allTabs.forEach(tab => tab.classList.remove('active'));

                // Desactivar todos los botones
                const allButtons = document.querySelectorAll('.tab-button');
                allButtons.forEach(btn => btn.classList.remove('active'));

                // Mostrar tab seleccionado
                document.getElementById(tabId).classList.add('active');

                // Activar bot√≥n seleccionado
                event.target.classList.add('active');
            }

            // Funci√≥n para expandir/contraer tarjetas
            function expandCard(event, contentId) {
                event.stopPropagation();
                const content = document.getElementById(contentId + '-content');
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            }

            // Funci√≥n para expandir/contraer solicitud
            function expandirSolicitud(element) {
                const body = element.querySelector('.solicitud-body');
                if (body.style.display === 'none') {
                    body.style.display = 'block';
                } else {
                    body.style.display = 'none';
                }
            }

            // Funci√≥n para abrir modal Ver Solicitudes
            function abrirModalVerSolicitudes(event) {
                event.stopPropagation();
                document.getElementById('modal-ver-solicitudes').style.display = 'flex';
            }

            // Funci√≥n para cerrar modal Ver Solicitudes
            function cerrarModalVerSolicitudes() {
                document.getElementById('modal-ver-solicitudes').style.display = 'none';
            }

            // Funci√≥n para abrir modal Nueva Solicitud
            function abrirModalNuevaSolicitud(event) {
                event.stopPropagation();
                document.getElementById('modal-nueva-solicitud').style.display = 'flex';
            }

            // Funci√≥n para cerrar modal Nueva Solicitud
            function cerrarModalNuevaSolicitud() {
                document.getElementById('modal-nueva-solicitud').style.display = 'none';
            }

            // Funci√≥n para abrir modal Nueva Mascota
            function abrirModalNuevaMascota(event) {
                event.stopPropagation();
                document.getElementById('modal-nueva-mascota').style.display = 'flex';
            }

            // Funci√≥n para cerrar modal Nueva Mascota
            function cerrarModalNuevaMascota() {
                document.getElementById('modal-nueva-mascota').style.display = 'none';
            }

            // Funci√≥n para abrir modal Ver Mascotas
            function abrirModalVerMascotas(event) {
                event.stopPropagation();
                document.getElementById('modal-ver-mascotas').style.display = 'flex';
            }

            // Funci√≥n para cerrar modal Ver Mascotas
            function cerrarModalVerMascotas() {
                document.getElementById('modal-ver-mascotas').style.display = 'none';
            }

            // Variables globales para crop
            let isDragging = false;
            let activeHandle = null;
            let cropFrame = { top: 30, left: 30, width: 240, height: 240 };
            const minSize = 80;
            const containerSize = 300;

            // Inicializar handles
            function inicializarHandles() {
                const handles = ['tl', 'tr', 'bl', 'br'];
                handles.forEach(handle => {
                    const el = document.getElementById(`handle-${handle}`);
                    el.addEventListener('mousedown', (e) => iniciarCropDrag(e, handle));
                    el.addEventListener('touchstart', (e) => iniciarCropDrag(e, handle));
                });
                actualizarOpaqueOverlay();
            }

            function iniciarCropDrag(event, handle) {
                event.preventDefault();
                isDragging = true;
                activeHandle = handle;
                document.addEventListener('mousemove', moverHandle);
                document.addEventListener('touchmove', moverHandle);
                document.addEventListener('mouseup', detenerCropDrag);
                document.addEventListener('touchend', detenerCropDrag);
            }

            function moverHandle(event) {
                if (!isDragging || !activeHandle) return;
                event.preventDefault();

                const container = document.getElementById('preview-container');
                const rect = container.getBoundingClientRect();
                let x, y;

                if (event.touches) {
                    x = event.touches[0].clientX - rect.left;
                    y = event.touches[0].clientY - rect.top;
                } else {
                    x = event.clientX - rect.left;
                    y = event.clientY - rect.top;
                }

                x = Math.max(0, Math.min(containerSize, x));
                y = Math.max(0, Math.min(containerSize, y));

                switch (activeHandle) {
                    case 'tl':
                        cropFrame.left = Math.min(x, cropFrame.left + cropFrame.width - minSize);
                        cropFrame.top = Math.min(y, cropFrame.top + cropFrame.height - minSize);
                        cropFrame.width = cropFrame.left + cropFrame.width - Math.min(x, cropFrame.left);
                        cropFrame.height = cropFrame.top + cropFrame.height - Math.min(y, cropFrame.top);
                        break;
                    case 'tr':
                        cropFrame.top = Math.min(y, cropFrame.top + cropFrame.height - minSize);
                        cropFrame.width = Math.max(minSize, x - cropFrame.left);
                        cropFrame.height = cropFrame.top + cropFrame.height - Math.min(y, cropFrame.top);
                        break;
                    case 'bl':
                        cropFrame.left = Math.min(x, cropFrame.left + cropFrame.width - minSize);
                        cropFrame.height = Math.max(minSize, y - cropFrame.top);
                        cropFrame.width = cropFrame.left + cropFrame.width - Math.min(x, cropFrame.left);
                        break;
                    case 'br':
                        cropFrame.width = Math.max(minSize, x - cropFrame.left);
                        cropFrame.height = Math.max(minSize, y - cropFrame.top);
                        break;
                }

                cropFrame.left = Math.max(0, Math.min(containerSize - minSize, cropFrame.left));
                cropFrame.top = Math.max(0, Math.min(containerSize - minSize, cropFrame.top));
                cropFrame.width = Math.min(containerSize - cropFrame.left, cropFrame.width);
                cropFrame.height = Math.min(containerSize - cropFrame.top, cropFrame.height);

                actualizarCropFrame();
                actualizarOpaqueOverlay();
            }

            function detenerCropDrag() {
                isDragging = false;
                activeHandle = null;
                document.removeEventListener('mousemove', moverHandle);
                document.removeEventListener('touchmove', moverHandle);
                document.removeEventListener('mouseup', detenerCropDrag);
                document.removeEventListener('touchend', detenerCropDrag);
            }

            function actualizarCropFrame() {
                const frame = document.getElementById('crop-frame');
                const tlHandle = document.getElementById('handle-tl');
                const trHandle = document.getElementById('handle-tr');
                const blHandle = document.getElementById('handle-bl');
                const brHandle = document.getElementById('handle-br');

                frame.style.top = cropFrame.top + 'px';
                frame.style.left = cropFrame.left + 'px';
                frame.style.width = cropFrame.width + 'px';
                frame.style.height = cropFrame.height + 'px';

                tlHandle.style.top = (cropFrame.top - 10) + 'px';
                tlHandle.style.left = (cropFrame.left - 10) + 'px';

                trHandle.style.top = (cropFrame.top - 10) + 'px';
                trHandle.style.right = (containerSize - cropFrame.left - cropFrame.width - 10) + 'px';

                blHandle.style.bottom = (containerSize - cropFrame.top - cropFrame.height - 10) + 'px';
                blHandle.style.left = (cropFrame.left - 10) + 'px';

                brHandle.style.bottom = (containerSize - cropFrame.top - cropFrame.height - 10) + 'px';
                brHandle.style.right = (containerSize - cropFrame.left - cropFrame.width - 10) + 'px';
            }

            function actualizarOpaqueOverlay() {
                const overlayLeft = document.getElementById('overlay-left');
                const overlayTop = document.getElementById('overlay-top');
                const overlayRight = document.getElementById('overlay-right');
                const overlayBottom = document.getElementById('overlay-bottom');

                overlayLeft.style.width = cropFrame.left + 'px';
                overlayLeft.style.height = containerSize + 'px';

                overlayTop.style.width = containerSize + 'px';
                overlayTop.style.height = cropFrame.top + 'px';

                overlayRight.style.width = (containerSize - cropFrame.left - cropFrame.width) + 'px';
                overlayRight.style.height = containerSize + 'px';
                overlayRight.style.right = '0';

                overlayBottom.style.width = containerSize + 'px';
                overlayBottom.style.height = (containerSize - cropFrame.top - cropFrame.height) + 'px';
                overlayBottom.style.bottom = '0';
            }

            // Funci√≥n para mostrar preview
            function previewImagenMascota(event) {
                const file = event.target.files[0];
                const previewContainer = document.getElementById('preview-foto-mascota');
                const previewImg = document.getElementById('preview-img-mascota');

                // Resetear crop
                cropFrame = { top: 30, left: 30, width: 240, height: 240 };

                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        previewContainer.style.display = 'block';
                        setTimeout(() => {
                            inicializarHandles();
                            actualizarCropFrame();
                        }, 100);
                    };
                    reader.onerror = function () {
                        console.error('Error al leer archivo');
                        previewContainer.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else if (file) {
                    alert('Por favor selecciona un archivo de imagen v√°lido.');
                    previewContainer.style.display = 'none';
                } else {
                    previewContainer.style.display = 'none';
                }
            }
        </script>
</body>

</html>